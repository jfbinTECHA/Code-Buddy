{"name":"Bytebot Mission Control Safe Shutdown + Grace Restart + Verification (Fixed Endpoint)","type":"scheduled_task","schedule":"*/15 * * * *","commands":["echo 'ğŸ§  [$(date)] Safe Shutdown Supervisor running...'","fail_count_file=/tmp/bytebot_failcount.txt","shutdown_marker=/tmp/bytebot_safe_shutdown_marker.txt","last_shutdown_time=$(cat $shutdown_marker 2>/dev/null || echo 0)","port=9991; status=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:$port/health)","if [ \"$status\" -ne 200 ]; then port=9990; status=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:$port/health); fi","# âœ… Healthy â†’ reset counters and exit","if [ \"$status\" -eq 200 ]; then","  echo 'âœ… Agent healthy on port '$port;","  echo 0 > $fail_count_file;","  rm -f $shutdown_marker 2>/dev/null;","  exit 0;","fi","# âš ï¸ Failure â†’ increment counter","count=$(cat $fail_count_file 2>/dev/null || echo 0); count=$((count+1)); echo $count > $fail_count_file;","echo 'âš ï¸ Consecutive failures: '$count;","# ğŸ›‘ Shutdown after 3 failures","if [ $count -ge 3 ]; then","  now=$(date +%s);","  if [ -f $shutdown_marker ]; then","    diff=$(( (now - last_shutdown_time) / 60 ));","    if [ $diff -ge 60 ]; then","      echo 'â±ï¸ 1-hour grace elapsed â€” restarting containers...';","      docker compose -f Code-Buddy/bytebotd/docker-compose.ops.yml up -d;","      echo 0 > $fail_count_file;","      rm -f $shutdown_marker;","      sleep 10;","      verify=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:9991/health);","      if [ \"$verify\" -eq 200 ]; then msg='âœ… Bytebot auto-restarted successfully on port 9991.'; color=65280; else verify2=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:$port/health); if [ \"$verify2\" -eq 200 ]; then msg='âœ… Bytebot auto-restarted successfully on port 9990.'; color=65280; else msg='ğŸš¨ Restart attempted but health still failing.'; color=15105570; fi; fi;","      echo \"$msg\";","      if [ -n \"$BYTEBOT_DISCORD_WEBHOOK\" ]; then curl -s -H 'Content-Type: application/json' -d '{\"embeds\":[{\"title\":\"ğŸ”„ Bytebot Auto-Restart\",\"description\":\"'$msg'\",\"color\":'$color'}]}' \"$BYTEBOT_DISCORD_WEBHOOK\" >/dev/null; fi;","      exit 0;","    else","      echo 'ğŸ•’ Grace period not yet reached ('$diff' min elapsed). System remains paused.';","      exit 0;","    fi;","  fi;","  echo 'ğŸš¨ 3 consecutive failures â€” performing safe shutdown.';","  docker compose -f Code-Buddy/bytebotd/docker-compose.ops.yml stop;","  echo $(date +%s) > $shutdown_marker;","  echo 0 > $fail_count_file;","  if [ -n \"$BYTEBOT_DISCORD_WEBHOOK\" ]; then curl -s -H 'Content-Type: application/json' -d '{\"embeds\":[{\"title\":\"ğŸ›‘ Bytebot Safe Shutdown Triggered\",\"description\":\"All containers stopped after 3 failed recoveries. Auto-restart will retry after 1-hour grace window.\",\"color\":15105570}]}' \"$BYTEBOT_DISCORD_WEBHOOK\" >/dev/null; fi;","  echo 'ğŸ›‘ Containers stopped. 1-hour restart grace window started.';","else","  echo 'ğŸ©º Failures below threshold. Monitoring continues...';","fi"]}